<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Texas Aerial Robotics Documentation: Texas Aerial Robotics ROS package</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Texas Aerial Robotics Documentation
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_eric_catkin_ws_src_Controls-ROS_README.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Texas Aerial Robotics ROS package </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this repository are the files nessary to build our ROS (Robot Operating System) package.</p>
<p>We use <b>Ubuntu 18.04</b> and <b>ROS Melodic</b></p>
<p>This package is loaded and runs on our Nvidia Jetson TX2 onboard the quadcopter.</p>
<p>It then feeds commands to the Pixhawk 2 using MAVROS.</p>
<p>Note that there is a <b>Troubleshooting</b> section at the bottom of this page.</p>
<p>Code blocks are meant to be typed in Terminal windows. "Control+Alt+T" opens a new Terminal window.</p>
<h2>1. Install ROS</h2>
<ul>
<li>Do <em>Desktop Install</em></li>
<li>Follow until <em>Step 1.7</em> at the end of the page</li>
</ul>
<p>First, install <b>ROS Melodic</b> using the following instructions: <a href="http://wiki.ros.org/melodic/Installation/Ubuntu">http://wiki.ros.org/melodic/Installation/Ubuntu</a></p>
<h2>2. Set Up Catkin workspace</h2>
<p>We use <code>catkin build</code> instead of <code>catkin_make</code>. Please install the following: </p><div class="fragment"><div class="line">sudo apt-get install python-wstool python-rosinstall-generator python-catkin-tools</div></div><!-- fragment --><p>Then, initialize the catkin workspace: </p><div class="fragment"><div class="line">mkdir -p ~/catkin_ws/src</div><div class="line">cd ~/catkin_ws</div><div class="line">catkin init</div></div><!-- fragment --><h2>3. Dependencies installation</h2>
<p>Install <code>mavros</code> and <code>mavlink</code> from source: </p><div class="fragment"><div class="line">cd ~/catkin_ws</div><div class="line">wstool init ~/catkin_ws/src</div><div class="line"></div><div class="line">rosinstall_generator --upstream mavros | tee /tmp/mavros.rosinstall</div><div class="line">rosinstall_generator mavlink | tee -a /tmp/mavros.rosinstall</div><div class="line">wstool merge -t src /tmp/mavros.rosinstall</div><div class="line">wstool update -t src</div><div class="line">rosdep install --from-paths src --ignore-src --rosdistro `echo $ROS_DISTRO` -y</div><div class="line"></div><div class="line">catkin build</div></div><!-- fragment --><p>Open your <code>~/.bashrc</code> for editing: </p><div class="fragment"><div class="line">gedit ~/.bashrc</div></div><!-- fragment --><p>Add this line to end of <code>~/.bashrc</code>: </p><div class="fragment"><div class="line">source ~/catkin_ws/devel/setup.bash</div></div><!-- fragment --><p> Save and exit. Then run: </p><div class="fragment"><div class="line">source ~/.bashrc</div></div><!-- fragment --><h2>4. Clone our ROS package repository</h2>
<div class="fragment"><div class="line">cd ~/catkin_ws/src</div><div class="line">git clone https://github.com/Texas-Aerial-Robotics/Controls-ROS.git</div></div><!-- fragment --><p> Our repository should now be copied to <code>~/catkin_ws/src/Controls-ROS/</code> (don't run this line. This is just saying that if you browse in the file manager, you will see those folders).</p>
<h2>5. Build instructions</h2>
<p>Inside <code>catkin_ws</code>, run <code>catkin build</code>:</p>
<div class="fragment"><div class="line">cd ~/catkin_ws</div><div class="line">catkin build</div></div><!-- fragment --><h2>6. Install Ardupilot</h2>
<p>In home directory: </p><div class="fragment"><div class="line">cd ~</div><div class="line">git clone https://github.com/Texas-Aerial-Robotics/ardupilot.git</div><div class="line">cd ardupilot</div><div class="line">git checkout Copter-3.5</div><div class="line">git submodule update --init --recursive</div></div><!-- fragment --><p>Install some packages: </p><div class="fragment"><div class="line">sudo apt install python-matplotlib python-serial python-wxgtk3.0 python-wxtools python-lxml python-scipy python-opencv ccache gawk git python-pip python-pexpect</div><div class="line">sudo pip2 install future pymavlink MAVProxy</div></div><!-- fragment --><p>Open <code>~/.bashrc</code> for editing: </p><div class="fragment"><div class="line">gedit ~/.bashrc</div></div><!-- fragment --><p>Add these lines to end of <code>~/.bashrc</code> (the file open in the text editor): </p><div class="fragment"><div class="line">export PATH=$PATH:$HOME/ardupilot/Tools/autotest</div><div class="line">export PATH=/usr/lib/ccache:$PATH</div></div><!-- fragment --><p>Save and close the text editor.</p>
<p>Reload <code>~/.bashrc</code>: </p><div class="fragment"><div class="line">. ~/.bashrc</div></div><!-- fragment --><p>Run SITL (Software In The Loop) once to set params: </p><div class="fragment"><div class="line">cd ~/ardupilot/ArduCopter</div><div class="line">sim_vehicle.py -w</div></div><!-- fragment --><p>Once the new Terminal window pops up and you see the ArduPilot software say "READY TO FLY," you can kill the process by hitting "Control+C" in the Terminal it is running out of.</p>
<h2>7. Install Gazebo</h2>
<p>Setup your computer to accept software from <a href="http://packages.osrfoundation.org:">http://packages.osrfoundation.org:</a> </p><div class="fragment"><div class="line">sudo sh -c &#39;echo &quot;deb http://packages.osrfoundation.org/gazebo/ubuntu-stable `lsb_release -cs` main&quot; &gt; /etc/apt/sources.list.d/gazebo-stable.list&#39;</div></div><!-- fragment --><p>Setup keys: </p><div class="fragment"><div class="line">wget http://packages.osrfoundation.org/gazebo.key -O - | sudo apt-key add -</div></div><!-- fragment --><p>Reload software list: </p><div class="fragment"><div class="line">sudo apt update</div></div><!-- fragment --><p>Install Gazebo: </p><div class="fragment"><div class="line">sudo apt install gazebo9 libgazebo9-dev</div></div><!-- fragment --><p>Install ROS plugins: </p><div class="fragment"><div class="line">sudo apt install ros-melodic-gazebo-ros ros-melodic-gazebo-plugins</div></div><!-- fragment --><p>Get Gazebo plugin for APM (ArduPilot Master): </p><div class="fragment"><div class="line">cd ~</div><div class="line">git clone https://github.com/SwiftGust/ardupilot_gazebo</div><div class="line">cd ardupilot_gazebo</div><div class="line">git checkout gazebo9</div><div class="line">mkdir build</div><div class="line">cd build</div><div class="line">cmake ..</div><div class="line">make -j4</div><div class="line">sudo make install</div></div><!-- fragment --><p>Set paths for models: </p><div class="fragment"><div class="line">echo &#39;export GAZEBO_MODEL_PATH=~/ardupilot_gazebo/gazebo_models&#39; &gt;&gt; ~/.bashrc</div><div class="line">. ~/.bashrc</div></div><!-- fragment --><p>Add Gazebo Models: </p><div class="fragment"><div class="line">hg clone https://bitbucket.org/osrf/gazebo_models ~/gazebo_ws/gazebo_models</div><div class="line">cd ~/gazebo_ws/gazebo_models</div><div class="line">echo &#39;export GAZEBO_MODEL_PATH=~/gazebo_ws/gazebo_models&#39; &gt;&gt; ~/.bashrc</div><div class="line">source ~/.bashrc</div></div><!-- fragment --><h2>8. Run Simulator</h2>
<p>In one Terminal (Terminal 1), run SITL: </p><div class="fragment"><div class="line">cd ~/ardupilot/ArduCopter/</div><div class="line">sim_vehicle.py -j4 -f Gazebo --console</div></div><!-- fragment --><p>In another Terminal (Terminal 2), run Gazebo: </p><div class="fragment"><div class="line">gazebo --verbose ~/ardupilot_gazebo/gazebo_worlds/iris_irlock_demo.world</div></div><!-- fragment --><p>Set parameters for sim in the same window after you run the <code>sim_vehicle.py script</code>. Do this by using command <code>param load &lt;filename&gt;</code> Example params can be found in the <code>Controls-Other</code> repo: <a href="https://github.com/Texas-Aerial-Robotics/Controls-Other">https://github.com/Texas-Aerial-Robotics/Controls-Other</a></p>
<p>To load our parameters, clone our <code>Controls-Other</code> repository (Terminal 3): </p><div class="fragment"><div class="line">cd ~</div><div class="line">git clone https://github.com/Texas-Aerial-Robotics/Controls-Other</div></div><!-- fragment --><p> In the Ardupilot simulator Terminal (Terminal 1) run: </p><div class="fragment"><div class="line">param load ../../Controls-Other/Params/Sim_master.param</div></div><!-- fragment --><p> Play around, then close by "Control+C" in the Terminal windows.</p>
<h2>9. Install Roomba Drone Simulator</h2>
<p>In order to use the Ardupilot simulator with the Roombas - as well as other plugins such as cameras - you need to add ROS packages to Gazebo. Install the following dependencies: </p><div class="fragment"><div class="line">sudo apt install ros-melodic-gazebo-ros ros-melodic-gazebo-plugins</div></div><!-- fragment --><p>Clone in Gazebo-Ros in your catkin_ws and the Computations repo in your home directory: </p><div class="fragment"><div class="line">cd ~/catkin_ws/src</div><div class="line">git clone https://github.com/Texas-Aerial-Robotics/Gazebo-Ros.git</div><div class="line">cd ~</div><div class="line">git clone https://github.com/Texas-Aerial-Robotics/Computations.git</div></div><!-- fragment --><p>Add the following to your <code>~/.bashrc</code> to use the Roomba plugins: </p><div class="fragment"><div class="line">export GAZEBO_MODEL_PATH=${GAZEBO_MODEL_PATH}:~/Computations/roomba_host/models</div><div class="line">export GAZEBO_PLUGIN_PATH=${GAZEBO_PLUGIN_PATH}:~/Computations/roomba_host/build</div></div><!-- fragment --><p>Build the ROS packages you just downloaded: </p><div class="fragment"><div class="line">cd ~/catkin_ws/</div><div class="line">catkin build</div></div><!-- fragment --><p>Reload <code>~/.bashrc</code> so the Terminal knows where the packages are located: </p><div class="fragment"><div class="line">source ~/.bashrc</div></div><!-- fragment --><h3>Run a sim with roslaunch</h3>
<p>In one Terminal (Terminal 1): </p><div class="fragment"><div class="line">roslaunch gazebo_ros_sim droneOnly.launch</div></div><!-- fragment --><p> In another Terminal (Terminal 2), run the following command to start and connect the Ardupilot simulator to Gazebo: </p><div class="fragment"><div class="line">cd ~/ardupilot/ArduCopter/ &amp;&amp; sim_vehicle.py -f gazebo-iris --console -I0</div></div><!-- fragment --><p> Play around, then close by "Control+C" in the Terminal windows.</p>
<h3>To view camera plugin</h3>
<p>Install image view: </p><div class="fragment"><div class="line">sudo apt install ros-melodic-image-view</div></div><!-- fragment --><p>To see camera view: </p><div class="fragment"><div class="line">rosrun image_view image_view image:=/webcam/image_raw</div></div><!-- fragment --><h2>10. Run Mavros Scripts from Controls-Ros package</h2>
<p>Launch the sim via roslaunch (Terminal 1): </p><div class="fragment"><div class="line">roslaunch gazebo_ros_sim droneOnly.launch</div></div><!-- fragment --><p> In another Terminal (Terminal 2) run the following command to start and connect the Ardupilot sim to Gazebo: </p><div class="fragment"><div class="line">cd ~/ardupilot/ArduCopter/ &amp;&amp; sim_vehicle.py -f gazebo-iris --console -I0</div></div><!-- fragment --><p> In another Terminal (Terminal 3) run: </p><div class="fragment"><div class="line">cd ~/Controls-Other/Launch/</div><div class="line">roslaunch apm.launch</div></div><!-- fragment --><p> Be sure to wait for the drone to go throught the full initialization process. The drone will be ready to fly once the console reads Optical Flow now aiding and origin set to GPS. For the competition we will not use GPS to home the drone, but for introduction sake let the drone use GPS</p>
<p>In another Terminal (Terminal 4) run: </p><div class="fragment"><div class="line">rosrun flight_pkg staple</div></div><!-- fragment --><p>Then in MavProxy (Terminal 2) switch the mode into <code>guided</code>: </p><div class="fragment"><div class="line">mode GUIDED</div></div><!-- fragment --><p>you did it! 🎉</p>
<hr/>
<h2>Troubleshooting and Common Problems:</h2>
<h3>During Catkin Build:</h3>
<p>#### Complains about "GeographicLib" </p><div class="fragment"><div class="line">cd ~/catkin_ws/src/mavros/mavros/scripts</div><div class="line">sudo ./install_geographiclib_datasets.sh</div></div><!-- fragment --><p>#### Complains about "Geometry Msgs" </p><div class="fragment"><div class="line">sudo apt install ros-melodic-geometry-msgs</div></div><!-- fragment --><hr/>
<p>References:</p><ul>
<li><a href="https://dev.px4.io/en/ros/mavros_installation.html#source-installation">https://dev.px4.io/en/ros/mavros_installation.html#source-installation</a></li>
<li><a href="http://wiki.ros.org/catkin/Tutorials/create_a_workspace">http://wiki.ros.org/catkin/Tutorials/create_a_workspace</a></li>
<li><a href="https://github.com/ArduPilot/ardupilot_wiki/issues/1001">https://github.com/ArduPilot/ardupilot_wiki/issues/1001</a></li>
<li><a href="https://github.com/AS4SR/general_info/wiki/ArduPilot:-Instructions-to-set-up-and-run-an-autopilot-using-SITL-and-Gazebo-simulator">https://github.com/AS4SR/general_info/wiki/ArduPilot:-Instructions-to-set-up-and-run-an-autopilot-using-SITL-and-Gazebo-simulator</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
