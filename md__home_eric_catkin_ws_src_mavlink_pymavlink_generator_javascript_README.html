<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Texas Aerial Robotics Documentation: Javascript MAVLink implementation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Texas Aerial Robotics Documentation
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__home_eric_catkin_ws_src_mavlink_pymavlink_generator_javascript_README.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Javascript MAVLink implementation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This code generates <code>npm</code> modules that can be used with Node.js. As with the other implementations in Python and C, the MAVLink protocol is specified in XML manifests which can be modified to add custom messages.</p>
<p><em>See the gotcha's and todo's section below</em> for some important caveats. This implementation should be considered pre-beta: it creates a working MAVLink parser, but there's plenty of rough edges in terms of API.</p>
<h3>Generating the JS implementation</h3>
<p>Folders in the <code>implementations/</code> directory are <code>npm</code> modules, automatically generated from XML manifests that are in the <a href="https://github.com/mavlink/mavlink">mavlink/mavlink</a> project. If you wish to generate custom MAVLink packets, you would need to follow the directions there.</p>
<p>You need to have Node.js and npm installed to build.</p>
<p>To build the Javascript implementations:</p>
<div class="fragment"><div class="line">npm install</div></div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">make</div></div><!-- fragment --><p>(which calls npm)</p>
<h3>Usage in Node.js</h3>
<p>The generated modules emit events when valid MAVLink messages are encountered. The name of the event is the same as the name of the message: <code>HEARTBEAT</code>, <code>FETCH_PARAM_LIST</code>, <code>REQUEST_DATA_STREAM</code>, etc. In addition, a generic <code>message</code> event is emitted whenever a message is successfully decoded.</p>
<p>The below code is a rough sketch of how to use the generated module in Node.js. A somewhat more complete (though early, early alpha) example can be found <a href="https://github.com/acuasi/ground-control-station">here</a>.</p>
<h4>Generating the parser</h4>
<p>After running the generator, copy the version of the MAVLink protocol you need into your project's <code>node_modules</code> folder, then enter that directory and install its dependencies using <code>npm install</code>:</p>
<div class="fragment"><div class="line">cp -R javascript/implementations/mavlink_ardupilotmega_v1.0 /path/to/my/project/node_modules/</div><div class="line">cd /path/to/my/project/node_modules/mavlink_ardupilotmega_v1.0 &amp;&amp; npm install</div></div><!-- fragment --><p>Then, you can use the MAVLink module, as sketched below.</p>
<h4>Initializing the parser</h4>
<p>In your <code>server.js</code> script, you need to include the generated parser and instantiate it; you also need some kind of binary stream library that can read/write binary data and emit an event when new data is ready to be parsed (<a class="el" href="classTCP.html">TCP</a>, <a class="el" href="classUDP.html">UDP</a>, serial port all have appropriate libraries in the npm-o-sphere). The connection's "data is ready" event is bound to invoke the MAVLink parser to try and extract a valid message.</p>
<div class="fragment"><div class="line">// requires Underscore.js and jspack</div><div class="line">// can use Winston for logging</div><div class="line">// see package.json for dependencies for the implementation</div><div class="line">var mavlink = require(&#39;mavlink_ardupilotmega_v1.0&#39;), </div><div class="line">    net = require(&#39;net&#39;);</div><div class="line"></div><div class="line">// Instantiate the parser</div><div class="line">// logger: pass a Winston logger or null if not used</div><div class="line">// 1: source system id</div><div class="line">// 50: source component id</div><div class="line">mavlinkParser = new MAVLink(logger, 1, 50);</div><div class="line"></div><div class="line">// Create a connection -- can be anything that can receive/send binary</div><div class="line">connection = net.createConnection(5760, &#39;127.0.0.1&#39;);</div><div class="line"></div><div class="line">// When the connection issues a &quot;got data&quot; event, try and parse it</div><div class="line">connection.on(&#39;data&#39;, function(data) {</div><div class="line">    mavlinkParser.parseBuffer(data);</div><div class="line">});</div></div><!-- fragment --><h4>Receiving MAVLink messages</h4>
<p>If the serial buffer has a valid MAVLink message, the message is removed from the buffer and parsed. Upon parsing a valid message, the MAVLink implementation emits two events: <code>message</code> (for any message) and the specific message name that was parsed, so you can listen for specific messages and handle them.</p>
<div class="fragment"><div class="line">// Attach an event handler for any valid MAVLink message</div><div class="line">mavlinkParser.on(&#39;message&#39;, function(message) {</div><div class="line">    console.log(&#39;Got a message of any type!&#39;);</div><div class="line">    console.log(message);</div><div class="line">});</div><div class="line"></div><div class="line">// Attach an event handler for a specific MAVLink message</div><div class="line">mavlinkParser.on(&#39;HEARTBEAT&#39;, function(message) {</div><div class="line">    console.log(&#39;Got a heartbeat message!&#39;);</div><div class="line">    console.log(message); // message is a HEARTBEAT message</div><div class="line">});</div></div><!-- fragment --><h4>Sending MAVLink messages</h4>
<p><em>See the gotcha's and todo's section below</em> for some important caveats. The below code is preliminary and <em>will</em> change to be more direct. At this point, the MAVLink parser doesn't manage any state information about the UAV or the connection itself, so a few fields need to be fudged, as indicated below.</p>
<p>Sending a MAVLink message is done by creating the message object, populating its fields, and packing/sending it across the wire. Messages are defined in the generated code, and you can look up the parameter list/docs for each message type there. For example, the message <code>REQUEST_DATA_STREAM</code> has this signature:</p>
<div class="fragment"><div class="line">mavlink.messages.request_data_stream = function(target_system, target_component, req_stream_id, req_message_rate, start_stop) //...</div></div><!-- fragment --><p>Creating the message is done like this:</p>
<div class="fragment"><div class="line">request = new mavlink.messages.request_data_stream(1, 1, mavlink.MAV_DATA_STREAM_ALL, 1, 1);</div><div class="line"></div><div class="line">// Create a buffer consisting of the packed message, and send it across the wire.</div><div class="line">// You need to pass a MAVLink instance to pack. It will then take care of setting sequence number, system and component id.</div><div class="line">// Hack alert: the MAVLink connection could/should encapsulate this.</div><div class="line">p = new Buffer(request.pack(mavlinkParser));</div><div class="line">connection.write(p);</div></div><!-- fragment --><h3>Gotchas and todo's</h3>
<p>JavaScript doesn't have 64bit integers (long). The library that replaces Pythons struct converts <code>q</code> and <code>Q</code> into 3 part arrays: <code>[lowBits, highBits, unsignedFlag]</code>. These arrays can be used with int64 libraries such as <a href="https://github.com/dcodeIO/Long.js">Long.js</a>. See <a href="https://github.com/AndreasAntener/node-jspack/blob/master/test/int64.js">int64.js</a> for examples.</p>
<p>Current implementation tries to be as robust as possible. It doesn't throw errors but emits bad_data messages. Also it discards the buffer of a possible message as soon as if finds a valid prefix. Future improvements:</p><ul>
<li>Implement not so robust parsing: throw errors (similar to the Python version)</li>
<li>Implement trying hard: parse buffer char by char and don't just discard the expected length buffer if there is an error</li>
</ul>
<p>This code isn't great idiomatic Javascript (yet!), instead, it's more of a line-by-line translation from Python as much as possible.</p>
<p>The Python MAVLink code manages some information about the connection status (system/component attached, bad packets, durations/times, etc), and that work isn't completely present in this code yet.</p>
<p>Code to create/send MAVLink messages to a client is very clumsy at this point in time <em>and will change</em> to make it more direct.</p>
<p>Publish generated scripts as npm module.</p>
<h3>Development</h3>
<p>Unit tests cover basic packing/unpacking functionality against mock binary buffers representing valid MAVlink generated by the Python implementation. You need to have <a href="http://visionmedia.github.com/mocha/">mocha</a> installed to run the unit tests.</p>
<p>To run tests, use npm:</p>
<div class="fragment"><div class="line">npm test</div></div><!-- fragment --><p>Specific instructions for generating Jenkins-friendly output is done through the makefile as well:</p>
<div class="fragment"><div class="line">make ci</div></div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
